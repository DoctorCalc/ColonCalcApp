<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Identificador de riesgo CCR</title>
  
  <link rel="manifest" href="/ColonCalcApp/www/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ColonCalc">

  <link rel="apple-touch-icon" href="/ColonCalcApp/www/icons/icon-192.png">
  <link rel="icon" href="/ColonCalcApp/www/icons/icon-48.png" type="image/png">
  
  <style>
:root{
  --bg:rgba(213, 247, 214, 0.3); /* color de fondo */
  --card:#ffffff;   /* color de la modal */
  --accent:#006400;  /* verde oscuro */
  --accent-light:rgba(165, 214, 165, 0.5); /* color de las ventanitas check */
  --text:#222;
}
body{
  font-family:"Segoe UI", Roboto, Arial;
  margin:0;
  background:var(--bg);
  color:var(--text);
}

html, body {
  /* Evita que el usuario seleccione texto accidentalmente al pulsar r√°pido */
  -webkit-user-select: none;
  user-select: none;
    
  /* Elimina el retraso de 300ms al pulsar (hace que la app se sienta m√°s r√°pida) */
  touch-action: manipulation;
}

/* Pero permite que en los inputs s√≠ se pueda seleccionar texto para borrar/escribir */
  input, textarea {
  -webkit-user-select: text;
  user-select: text;
}

.container{
  max-width:950px;
  margin:20px auto;
  padding:16px;
}
header{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px;
  border-bottom:5px solid #062106;
  background:#006400;
}
header img{height:56px;width:auto;object-fit:contain;}
header .title{line-height:1;}
.no-interact {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: none; /* Esto evita el men√∫, pero tambi√©n el clic */
}
#main-card .small {
    margin-top: 5px;
    font-weight: 500; /* Un pel√≠n m√°s de peso para que gu√≠e mejor al usuario */
}

h1{font-size:1.9rem;margin:0;color:#f4f4f4;}
.muted{color:#f4f4f4;font-size:0.95rem;margin-top:6px;}
.card{
  background:var(--card);
  border-radius:14px;
  box-shadow:0 4px 16px rgba(0,0,0,.12);
  padding:20px;
  margin-top:18px;
}
.accent-green {
    accent-color: #006400;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
  margin-top:12px;
}
label.checkbox{
  display:flex;
  gap:10px;
  padding:14px;
  border-radius:12px;
  background:var(--accent-light);
  border:1px solid #006400;

  /* ‚≠ê Relieve / sombra moderna */
  box-shadow: 
      0 2px 4px rgba(0,0,0,0.20),
      0 4px 10px rgba(0,0,0,0.15);

  transition:0.22s ease;
  align-items:flex-start;
}

/* ‚≠ê efecto al pasar el dedo/ratoÃÅn */
label.checkbox:hover{
  background:rgba(213, 237, 215, 0.5);
  box-shadow:
      0 3px 6px rgba(0,0,0,0.25),
      0 6px 14px rgba(0,0,0,0.20);
  transform: translateY(-2px);
}

/* ‚≠ê cuando el checkbox est√° marcado */
label.checkbox input:checked + span,
label.checkbox:has(input:checked){
  background:#daf2db;
  border-color:#006400;
  box-shadow:
      0 4px 10px rgba(0,0,0,0.15),
      inset 0 0 0 2px #006400;
}
.actions {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  align-items:center;
  margin-top:16px;

  /* ‚≠ê A√±ade separaci√≥n hacia abajo */
  margin-bottom:22px;
}
/* ‚≠ê BOTONES PRINCIPALES CON RELIEVE */
button{
  background:var(--accent);
  color:#fff;
  border:0;
  padding:12px 18px;
  border-radius:12px;
  cursor:pointer;
  font-size:1rem;
  font-weight:600;

  /* relieve */
  box-shadow:
      0 4px 0 #062106,      /* borde inferior tipo bot√≥n f√≠sico */
      0 6px 12px rgba(0,0,0,0.18); /* sombra suave exterior */

  transition:transform .15s, box-shadow .15s, background .2s;
}

button:hover{
  background:#43a158;
}

button:active{
  transform:translateY(2px);     /* hundimiento */
  box-shadow:
      0 2px 0 #062106,
      0 3px 6px rgba(0,0,0,0.18);
}


button.secondary{
  background:#dcdcdc;
  color:#222;
  box-shadow:
      0 4px 0 #9e9e9e,
      0 6px 12px rgba(0,0,0,0.12);
}

button.secondary:active{
  transform:translateY(2px);
  box-shadow:
      0 2px 0 #9e9e9e,
      0 3px 6px rgba(0,0,0,0.12);
}

.result{
  margin-top:16px;
  padding:14px;
  border-radius:10px;
  font-size:1rem;
  opacity:1;
  scroll-margin-top: 120px; /* evita que quede pegado arriba */
}

/* Estilos comunes para todas las notas informativas de resultados */
.small,
.lynch-note, 
.gene-note, 
.adeno-note, 
.young-note, 
.serrated-note, 
.sps-note
.text-justify {
    display: block !important;
    text-align: justify !important;
    text-justify: inter-word !important;
    hyphens: auto !important;
    -webkit-hyphens: auto !important;
    line-height: 1.5;
    /* Importante: que no haya word-break: break-all que rompa el icono */
    word-break: break-word; 
}

/* Evitamos que el icono se mueva de su sitio */
.result-content {
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

#pregunta-num-fpg,
#pregunta-edad-fpg,
#result {
  scroll-margin-top: 120px;
}

.result.ok {
    background: #d9f7d9;
    border-left: 6px solid #2ca02c;
    padding: 15px; /* Para que el texto no toque los bordes */
}

/* Esto es lo que permite que el texto se cuadre */
.result.ok.text-justify {
    display: block !important;
    text-align: justify !important;
    hyphens: auto !important;
    -webkit-hyphens: auto !important;
}

/* Si usas un p dentro, que sea bloque tambi√©n */
.result.ok p {
    display: block; 
    margin: 0;
}
.result.warn{background:#ffe8e8;border-left:6px solid #cc0000;border:2px solid #cc0000;}
.hidden{display:none !important;}
select,input[type=number],input[type=text]{
  padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;margin-top:6px;box-sizing:border-box;
}
#modal-riesgo{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:none;opacity:0;transition:opacity .18s;}
#modal-riesgo.visible{pointer-events:auto;opacity:1;}
#modal-inner{background:#fff;padding:20px;border-radius:12px;max-width:420px;text-align:center;border:4px solid transparent;}
#modal-inner.high-alert{border-color:#ff0000;animation:flashRed 1.2s ease-in-out 0s 2;}
@keyframes flashRed{0%{box-shadow:0 0 0 0 rgba(255,0,0,.9);}50%{box-shadow:0 0 18px 8px rgba(255,0,0,.9);}100%{box-shadow:0 0 0 0 rgba(255,0,0,.9);}}
@media(max-width:600px){
  .container{padding:12px;}
  h1{font-size:1.3rem;}
  .grid{grid-template-columns:1fr;}
  .actions{flex-direction:column;}
  button{width:100%;}
}
.footer {
  text-align: justify;
  hyphens: auto;
  -webkit-hyphens: auto; /* Para compatibilidad con algunos m√≥viles antiguos */
  font-size: 0.80rem;    /* Tama√±o discreto */
  color: #6b7280;        /* Gris suave (text-gray-500) */
  line-height: 1.4;
  margin-top: 25px;      /* Espacio respecto a la calculadora */
  padding: 0 5px;        /* Un poco de aire en los bordes */
}

.footer-version {
  display: block;        /* Hace que la versi√≥n y autor bajen a una l√≠nea nueva */
  margin-top: 8px;
  font-size: 0.8rem;
  text-align: center;    /* El copyright suele quedar mejor centrado */
  opacity: 0.8;
}

.small{font-size:.95rem;color:#333;}

.nav-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  margin-bottom:24px;
}

/* ‚≠ê MINI BOTONES CON RELIEVE */
.nav-buttons .mini-btn {
  padding: 6px 12px;
  font-size: 0.85rem;
  border-radius: 8px;
  cursor: pointer;
  background: var(--accent);
  color: white;
  border: none;
  display: flex;
  align-items: center;
  gap: 6px;

  box-shadow:
      0 4px 0 #062106,
      0 5px 10px rgba(0,0,0,0.18);

  transition: transform .15s, box-shadow .15s;
}

.nav-buttons .mini-btn:active{
  transform:translateY(2px);
  box-shadow:
      0 2px 0 #062106,
      0 3px 6px rgba(0,0,0,0.18);
}


.nav-buttons .mini-btn.secondary {
  background:#dcdcdc;
  color:#222;
  box-shadow:
      0 4px 0 #9e9e9e,
      0 5px 10px rgba(0,0,0,0.15);
}

.nav-buttons .mini-btn.secondary:active {
  transform:translateY(2px);
  box-shadow:
      0 2px 0 #9e9e9e,
      0 3px 6px rgba(0,0,0,0.15);
}

.nav-buttons a {
  text-decoration: none !important;
}

/* Mantener la distribuci√≥n horizontal tambi√©n en m√≥vil */
@media(max-width:600px){
  .nav-buttons {
    justify-content: space-between;
  }
  .nav-buttons a, 
  .nav-buttons button {
    width: auto !important;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logodige.jpg" class="no-interact" alt="Logo Servicio" />
      <div class="title">
        <h1>Identificador de riesgo de CCR</h1>
        <div class="muted">Basado en los antecedentes personales/familiares</div>
      </div>
    </header>

    <section class="card" id="main-card">
      <p class="small">Marque la casilla que describa sus antecedentes personales o familiares m√°s relevantes:</p>

      <form id="risk-form" autocomplete="off" novalidate>
        <div class="grid" role="group" aria-label="Antecedentes personales y familiares">
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="ihq" /> Historia personal o familiar de CCR con alteraci√≥n de genes reparadores ADN (IHQ/IMS)</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="fpg_50" /> Historia personal o familiar de primer grado (FPG) con CCR ‚â§50 a√±os</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value=">=2fpg" /> ‚â• 2 FPG con CCR (o √°rea Lynch) (cualquier edad)</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value=">=20_adenomas" /> Historia personal o FPG con ‚â•20 adenomas acumulados a cualquier edad</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="young_10adenomas_or_advanced" /> Historia personal o FPG ‚â§40 a√±os con ‚â•10 adenomas acumulados o adenoma avanzado o manifestaciones extracol√≥nicas de PAF</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="serrated_criteria" /> Historia personal de ‚â•5 lesiones serradas proximales al √°ngulo espl√©nico o ‚â•2 lesiones serradas acumuladas de ‚â•10mm proximales</label>
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="sps" /> FPG de paciente con S√≠ndrome Polip√≥sico Serrado</label>

          <!-- casilla "ninguno" -->
          <label class="checkbox"><input type="checkbox" class="accent-green" name="factor" value="ninguno" /> No tengo ninguno de estos antecedentes</label>
        </div>
              
        <div class="actions">
          <button type="button" id="evaluate">Evaluar riesgo</button>
          <button type="button" id="reset" class="secondary">Borrar</button>
          <div style="margin-left:auto" class="small">El resultado aparecer√° aqu√≠ abajo.</div>
        </div>
        <div class="nav-buttons">
            <button type="button" class="mini-btn secondary" onclick="window.location.href='index.html'">
                ‚Üê Men√∫ principal
            </button>

            <button type="button" class="mini-btn" onclick="window.location.href='Calculadora.html'">
                Calculadora ‚Üí
            </button>
        </div>

        <div id="result" class="result hidden" aria-live="polite"></div>

        <div id="no-antecedents" class="card hidden" style="margin-top:12px;padding:12px">
          <p class="small"><strong>¬øTiene una colonoscopia con lesiones que precisen vigilancia?</strong></p>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
            <label><input type="radio" class="accent-green" name="colon-lesion" value="yes"> S√≠</label>
            <label><input type="radio" class="accent-green" name="colon-lesion" value="no"> No</label>
          </div>

          <div id="lesion-calculator" class="hidden" style="margin-top:12px">
            <div class="small">Abrir calculadora de vigilancia:</div>
            <div style="margin-top:8px">
              <a href="Calculadora.html" target="_blank" rel="noopener noreferrer"><button type="button">Ir a Calculadora</button></a>
            </div>
          </div>

          <div id="family-risk-section" class="hidden" style="margin-top:16px">

            <p class="small">
              <strong>Introduzca cu√°ntos familiares con c√°ncer colorrectal tiene, seg√∫n el grado de parentesco:</strong>
            </p>

            <div style="border:1px solid #99b; padding:14px; border-radius:12px; background:#f6f7ff; margin-top:10px;">
      
                <div style="font-weight:bold; margin-bottom:10px;">
                  Introduzca el n√∫mero de familiares con CCR en cada categor√≠a:
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                  <div>
                    <strong>Primer grado</strong><br>
                    <span class="small">(padres, hermanos, hijos)</span>
                  </div>
                  <input type="number" id="fam-primer" min="0" value="0" 
                         style="width:70px; margin-left:10px;">
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                  <div>
                    <strong>Segundo grado</strong><br>
                    <span class="small">(t√≠os, abuelos, sobrinos)</span>
                  </div>
                  <input type="number" id="fam-segundo" min="0" value="0" 
                         style="width:70px; margin-left:10px;">
                </div>

                <div style="display:flex; align-items:center; justify-content:space-between;">
                  <div>
                    <strong>Tercer grado</strong><br>
                    <span class="small">(primos, bisabuelos)</span>
                  </div>
                  <input type="number" id="fam-tercer" min="0" value="0" 
                         style="width:70px; margin-left:10px;">
                </div>

                <button id="eval-familiares" type="button" 
                        style="margin-top:14px; padding:8px 12px; font-size:0.9rem;
                               border-radius:8px; cursor:pointer; background:#006400; color:white;">
                  Evaluar
                </button>
            </div>

            <!-- Cuando hay 1 familiar de primer grado -->
            <div id="pregunta-edad-fpg" class="hidden" style="margin-top:16px;">
              <label class="small"><strong>Edad del familiar de primer grado cuando fue diagnosticado:</strong></label><br>
              <label><input type="radio" class="accent-green" name="edad-fpg" value="le50"> ‚â§ 50 a√±os</label>
              <label style="margin-left:10px;">
                <input type="radio" class="accent-green" name="edad-fpg" value="gt50"> > 50 a√±os
              </label>
            </div>

          </div>


        </div>

      </form>
    </section>

    <!-- ============ FOOTER NOTE ============ -->
    <div class="footer">
        <em>
            Esta aplicaci√≥n implementa las recomendaciones de las gu√≠as de la ESGE sobre CCR familiar de 2019 (Lynch y s√≠ndromes polip√≥sicos), para hacer una evaluaci√≥n r√°pida del riesgo. No sustituye la valoraci√≥n cl√≠nica. Para criterios complejos (confirmaci√≥n de s√≠ndromes gen√©ticos, pruebas moleculares o decisiones de derivaci√≥n), siga el protocolo local o derive a Unidad de Alto Riesgo.
            <span class="footer-version">
                        Versi√≥n 1.0.18. ¬© Paco Casado. Granada 2025.
            </span>
        </em>
    </div>

  <!-- modal -->
  <div id="modal-riesgo" class="hidden" aria-hidden="true">
    <div id="modal-inner">
      <h3 id="modal-titulo"></h3>
      <p id="modal-texto"></p>
      <div style="margin-top:12px"><button type="button" id="cerrar-modal">Cerrar</button></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('risk-form');
  const evaluateBtn = document.getElementById('evaluate');
  const resetBtn = document.getElementById('reset');
  const resultBox = document.getElementById('result');
  const noAnte = document.getElementById('no-antecedents');
  const lesionCalculator = document.getElementById('lesion-calculator');
  const familySection = document.getElementById('family-risk-section');
  const parentescoRadios = Array.from(document.getElementsByName('grado-parentesco'));
  const preguntaNumFPG = document.getElementById('pregunta-num-fpg');
  const preguntaEdadFPG = document.getElementById('pregunta-edad-fpg');
  const modal = document.getElementById('modal-riesgo');
  const modalInner = document.getElementById('modal-inner');
  const modalTitulo = document.getElementById('modal-titulo');
  const modalTexto = document.getElementById('modal-texto');
  const cerrarModalBtn = document.getElementById('cerrar-modal');
  const colonRadios = Array.from(document.getElementsByName('colon-lesion'));
  // üî• Permitir solo una casilla marcada a la vez
  // Reemplazo robusto: asegura foco sin salto y desplazamiento suave fiable en m√≥viles
const riskChecks = Array.from(document.querySelectorAll('input[name="factor"]'));
let scrollAnimationHandle = null;

function smoothScrollTo(targetY, duration = 420) {
  // Si el navegador soporta scrollBehavior, usarlo (simple)
  if ('scrollBehavior' in document.documentElement.style) {
    window.scrollTo({ top: Math.round(targetY), behavior: 'smooth' });
    return;
  }

  // Polyfill simple (requestAnimationFrame)
  if (scrollAnimationHandle) cancelAnimationFrame(scrollAnimationHandle);
  const startY = window.scrollY || window.pageYOffset;
  const diff = targetY - startY;
  const startTime = performance.now();

  function step(now) {
    const t = Math.min(1, (now - startTime) / duration);
    // easing (easeInOutQuad)
    const eased = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
    window.scrollTo(0, Math.round(startY + diff * eased));
    if (t < 1) {
      scrollAnimationHandle = requestAnimationFrame(step);
    } else {
      scrollAnimationHandle = null;
    }
  }
  scrollAnimationHandle = requestAnimationFrame(step);
}

riskChecks.forEach(chk => {
  chk.addEventListener('change', function(){
    if (this.checked) {
      // Desmarca todas las dem√°s
      riskChecks.forEach(other => { if (other !== this) other.checked = false; });

      // 1) Poner foco en el bot√≥n sin desplazar (previene jumps)
      try {
        evaluateBtn.focus({ preventScroll: true });
      } catch (e) {
        // fallback si el navegador no soporta preventScroll
        evaluateBtn.focus();
      }

      // 2) Calcular posici√≥n objetivo para centrar el bot√≥n (o ajusta offset si tienes cabecera fija)
      const rect = evaluateBtn.getBoundingClientRect();
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      // Queremos el bot√≥n centrado en pantalla; puedes cambiar '0.5' por otro factor
      const targetY = (window.scrollY || window.pageYOffset) + rect.top - (viewportHeight * 0.5) + (rect.height * 0.5);

      // 3) Peque√±o delay para dejar que el layout del m√≥vil se estabilice (evita saltos)
      setTimeout(() => smoothScrollTo(Math.max(0, targetY)), 80);
    }
  });
});


  function safeHide(...els){ els.forEach(el=> el && el.classList.add('hidden')); }
  function safeShow(el){ el && el.classList.remove('hidden'); }
  function resetAll(){
    try{
      if(form && typeof form.reset === 'function') form.reset();
      else {
        Array.from((form||document).querySelectorAll('input')).forEach(i=>{
          if(i.type==='checkbox' || i.type==='radio') i.checked=false; else i.value='';
        });
        Array.from((form||document).querySelectorAll('select')).forEach(s=>s.selectedIndex=0);
      }
    }catch(e){ console.warn('reset failed', e); }
    safeHide(resultBox, noAnte, lesionCalculator, familySection, preguntaNumFPG, preguntaEdadFPG, modal);
    resultBox.className='result hidden';
    resultBox.textContent='';
  }

  function abrirModal(tipo){
    if(!modal) return;
    modal.classList.add('visible');
    modal.classList.remove('hidden');
    if(modalInner) modalInner.classList.remove('high-alert');
    if(tipo==='alto'){
      modalTitulo.textContent='Riesgo elevado';
      modalTexto.textContent='Colonoscopia cada 5 a√±os a partir de los 40 a√±os o 10 a√±os antes que el familiar diagnosticado de CCR.';
      if(modalInner) modalInner.classList.add('high-alert');
    } else {
      modalTitulo.textContent='Riesgo normal';
      modalTexto.textContent='Cribado con sangre oculta en heces (SOH) cada 2 a√±os a partir de los 50 a√±os (programa poblacional).';
    }
  }

  function cerrarModal(){
    if(!modal) return;
    modal.classList.remove('visible');
    modal.classList.add('hidden');
  }
  function autoScroll(el){
  if(!el) return;
  setTimeout(()=>{
    el.scrollIntoView({ behavior:"smooth", block:"center" });
  }, 150);
  }


  // Evaluate
  const msgNoRiesgo = "No se identifican criterios de alto riesgo de c√°ncer colorrectal. Realizar cribado con test de sangre oculta en heces cada 2 a√±os seg√∫n el Programa de Detecci√≥n Precoz de CCR, si est√° dentro del rango de edad (50 - 69 a√±os). Si es mayor de 69 a√±os, depender√° de su estado de salud y su historial cl√≠nico. En este caso, consulte a su m√©dico.";
  evaluateBtn?.addEventListener('click', function(){
    try{
      safeHide(noAnte, lesionCalculator, familySection, preguntaNumFPG, preguntaEdadFPG);
      resultBox.className='result hidden';
      resultBox.textContent='';

      const checked = form ? Array.from(form.querySelectorAll('input[name="factor"]:checked')) : [];
      if(checked.length === 0){
        resultBox.className = 'result warn';
        resultBox.innerHTML = '<strong>‚ö†Ô∏è Debe seleccionar al menos una casilla</strong> para poder determinar el riesgo.';
        safeShow(resultBox);

        // desplazamiento autom√°tico al mensaje
        setTimeout(() => {
          resultBox.scrollIntoView({ behavior:"smooth", block:"center" });
        }, 150);

        return;
      }

      const vals = checked.map(i=>i.value);

      // If only "ninguno" is selected
      if(vals.includes('ninguno') && vals.length === 1){
          resultBox.className = 'result ok text-justify'; 
    
          // Icono pegado al texto. El espacio &nbsp; asegura un hueco fijo tras el check.
          resultBox.innerHTML = `‚úÖ&nbsp; ${msgNoRiesgo}`;
    
          safeShow(resultBox);
    
          setTimeout(() => {
              resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
          }, 150);
          return;
      }

      const highRiskCriteria = ['ihq','fpg_50','>=2fpg','>=20_adenomas','young_10adenomas_or_advanced','serrated_criteria','sps'];
      const highRisk = vals.some(v=> highRiskCriteria.includes(v));
      const needsFamilyFlow = vals.includes('fpg_50') || vals.includes('>=2fpg');

      if(highRisk){
        resultBox.className='result warn';
        resultBox.innerHTML = '<strong>‚ö†Ô∏è Riesgo elevado:</strong> Cumple criterios de Alto Riesgo.';

  // üî• A√±adido: p√°rrafo adicional solo si es ‚â•2 FPG / √°rea Lynch
        if (vals.includes('>=2fpg')) {
          if (!resultBox.querySelector('.lynch-note')) {
            const lynchNote = document.createElement('div');
            lynchNote.className = 'small lynch-note';
            lynchNote.style.marginTop = '10px';
            lynchNote.innerHTML = ` 
            No solo por tener dos o m√°s casos de c√°ncer colorrectal en familiares de primer grado de cualquier edad, sino tambien por tener familiares con otros tumores asociados al s√≠ndrome de Lynch (endometrio, ovario, est√≥mago, intestino delgado, v√≠as urinarias altas, hepatobiliar, cerebro y piel tipo seb√°ceo).
            En estos casos, se recomienda valoraci√≥n en Consulta de Alto Riesgo para estudio gen√©tico y planificaci√≥n de vigilancia personalizada.
            Haremos antes unas comprobaciones para evaluar el riesgo verdadero.
        `;
            resultBox.appendChild(lynchNote);
          }
        }
// üî• A√±adido: p√°rrafo adicional solo si es antecedentes de genes
        if (vals.includes('ihq')) {
          if (!resultBox.querySelector('.gene-note')) {
            const geneNote = document.createElement('div');
            geneNote.className = 'small gene-note';
            geneNote.style.marginTop = '10px';
            geneNote.innerHTML = ` 
            Si el paciente (o sus familiares) ha tenido un CCR con variantes patog√©nicas de algunos de los genes reparadores (MMR) MLH1, MSH2, MSH6, PMS2 o delecci√≥n en la regi√≥n 3 prima del gen EpCAM (investigados en los tumores), hay que estudiarlo por si tiene un S√≠ndrome de Lynch.
            Remitir a consulta de alto riesgo.
            En caso de tenerlas, se indicar√≠a colonoscopia <strong>cada 2 a√±os</strong> a partir de los 25 para portadores de mutaciones MLH1 y MSH2, y a partir de los 35 a√±os para MSH6 y PMS2, siempre que est√©n asintom√°ticos.
        `; 
            resultBox.appendChild(geneNote);
          }
        }
// üî• A√±adido: p√°rrafo adicional solo si es >20 adenomas
        if (vals.includes('>=20_adenomas')) {
          if (!resultBox.querySelector('.adeno-note')) {
            const adenoNote = document.createElement('div');
            adenoNote.className = 'small adeno-note';
            adenoNote.style.marginTop = '10px';
            adenoNote.innerHTML = ` 
            La presencia de 20 o m√°s adenomas puede indicar una poliposis de origen gen√©tico.
            La Poliposis Adenomatosa Familiar (PAF) es causada por una mutaci√≥n en el gen APC, de transimisi√≥n autos√≥mica dominante.
            Se caracteriza por entre 100 y 1000 adenomas y se asocia a manifestaciones extracol√≥nicas.
            En la PAF atenuada hay < 100 adenomas y no siempre se detecta la mutaci√≥n.
            La PAM se produce por mutaci√≥n bial√©lica en el gen MUTYH y se caracteriza por entre 20 y 100 adenomas.
            Remitir a consulta de alto riesgo para estudio de <strong>oligopoliposis</strong>.
            Se recomienda colonoscopia para PAF desde los 12-14 a√±os y para PAM desde los 18 a√±os.
            En caso de colon intacto, el intervalo ser√° entre <strong>1 y 2 a√±os</strong>, seg√∫n el n√∫mero de p√≥lipos.
        `;
            resultBox.appendChild(adenoNote);
          }
        }
// üî• A√±adido: p√°rrafo adicional solo si es >10 adenomas
        if (vals.includes('young_10adenomas_or_advanced')) {
          if (!resultBox.querySelector('.young-note')) {
            const youngNote = document.createElement('div');
            youngNote.className = 'small young-note';
            youngNote.style.marginTop = '10px';
            youngNote.innerHTML = ` 
            La presencia de 10 o m√°s adenomas en pacientes j√≥venes puede indicar una poliposis de origen gen√©tico.
            Las manifestaciones asociadas a la PAF son adenomas duodenales/ampulares, tumores desmoides, c√°ncer papilar de tiroides, hipertrofia cong√©nita del epitelio pigmentario de la retina, quistes epid√©rmicos y osteomas.
            La Poliposis Adenomatosa Familiar (PAF) es causada por una mutaci√≥n en el gen APC, de transimisi√≥n autos√≥mica dominante.
            Se caracteriza por entre 100 y 1000 adenomas y se asocia a manifestaciones extracol√≥nicas.
            En la PAF atenuada hay < 100 adenomas y no siempre se detecta la mutaci√≥n.
            La PAM se produce por mutaci√≥n bial√©lica en el gen MUTYH y se caracteriza por entre 20 y 100 adenomas.
            Remitir a consulta de alto riesgo. Se recomienda colonoscopia para PAF desde los 12-14 a√±os y para PAM desde los 18 a√±os.
        `; 
            resultBox.appendChild(youngNote);
          }
        }
// üî• A√±adido: p√°rrafo adicional solo si criterios serrados
        if (vals.includes('serrated_criteria')) {
          if (!resultBox.querySelector('.serrated-note')) {
            const serratedNote = document.createElement('div');
            serratedNote.className = 'small serrated-note';
            serratedNote.style.marginTop = '10px';
            serratedNote.innerHTML = ` 
            Se consideran lesiones serradas los <i>p√≥lipos hiperpl√°sicos, las lesiones serradas s√©siles</i> y los <i>adenomas serrados tradicionales</i>.
            La presencia de 5 o m√°s lesiones serradas proximales al √°ngulo espl√©nico o 2 o m√°s lesiones serradas avanzadas (‚â•10mm o con displasia) requiere vigilancia.
            Aunque no cumpla criterios de la OMS de S√≠ndrome de Poliposis Serrada, se suma el n√∫mero total de p√≥lipos serrados que se extirpan en sucesivas colonoscopias, por lo que hay que estar atentos.
            La vigilancia requiere colonoscopia a los <strong>3 a√±os</strong>, como en los adenomas, siempre que se hayan extirpado menos de 10 lesiones serradas.
            Si hay >10 (excepto hiperpl√°sicos de recto-sigma de <10mm), la vigilancia ser√° intensiva con colonoscopia en <strong>1 a√±o</strong>.
        `;
            resultBox.appendChild(serratedNote);
          }
        }
// üî• A√±adido: p√°rrafo adicional solo si criterios de SPS
        if (vals.includes('sps')) {
          if (!resultBox.querySelector('.sps-note')) {
            const spsNote = document.createElement('div');
            spsNote.className = 'small sps-note';
            spsNote.style.marginTop = '15px';
            spsNote.innerHTML = spsNote.innerHTML = `
            Se define el S√≠ndrome de Poliposis Serrada (SPS) seg√∫n los criterios de la OMS (2019). 
            Tiene que presentar uno de los siguientes criterios: <strong>criterio 1:</strong> ‚â•5 p√≥lipos serrados en colon proximal de ‚â•5mm y, al menos, dos de ellos tienen que ser ‚â•10mm. 
            <strong>Criterio 2:</strong> >20 p√≥lipos serrados de cualquier tama√±o en todo el colon, con ‚â•5 en colon proximal. 
            Se considera la forma de poliposis m√°s frecuente. Se agrupa dentro de los s√≠ndromes hereditarios, aunque no se ha encontrado ninguna mutaci√≥n. 
            Si el FPG tiene una colonoscopia con criterios de SPS, remitir a consulta de alto riesgo. 
            Requiere nueva colonoscopia <strong>al a√±o</strong>, siempre que se hayan extirpado todos los p√≥lipos. 
            Tras esa, se puede hacer cada 2 a√±os si no hay lesiones avanzadas o se extirpan <5 p√≥lipos serrados. 
            Si no tiene colonoscopia, habr√° que solicitarla a partir de los 45 a√±os y, si no hay p√≥lipos, cada 5 a√±os.
        `;
            resultBox.appendChild(spsNote);
          }
        }               
        safeShow(resultBox);

  // Desplazamiento a resultado
  setTimeout(() => {
    resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 150);

      // Desplazar a resultado en m√≥vil
         setTimeout(() => {
         resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 150);
          if(needsFamilyFlow){
          // add note if not present
          if(!resultBox.querySelector('.small')){
            const note = document.createElement('div');
            note.className='small';
            note.style.marginTop='8px';
            note.textContent='Si el paciente ha tenido un CCR con ‚â§ 50 a√±os tiene que ser remitido a consulta de alto riesgo (CAR) para estudio y seguimiento adecuado. Si se trata de familiares, habr√° que confirmar el grado de parentesco, n√∫mero y edad al diagn√≥stico. Para determinar los intervalos de vigilancia, indique si ya tiene una colonoscopia con lesiones.';
            resultBox.appendChild(note);
          }
          safeShow(noAnte);
        } else {
          safeHide(noAnte);
        }
      } else {
          resultBox.className = 'result ok text-justify'; // Aplicamos justificaci√≥n
          resultBox.innerHTML = `<p>${msgNoRiesgo}</p>`;
      
        safeShow(resultBox);
      // Desplazar a resultado en m√≥vil
         setTimeout(() => {
         resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 150);
      }

    }catch(err){ console.error('Evaluar error', err); }
  });

  // Colon radios
  colonRadios.forEach(r=>{
    r.addEventListener('change', function(e){
      try{
        if(e.target.value==='yes'){
          // Si S√ç hay lesiones ‚Üí mostrar calculadora, ocultar parentesco
          safeShow(lesionCalculator);
          safeHide(familySection);
        } else {
          // Si NO hay lesiones ‚Üí ocultar calculadora y mostrar parentesco
          safeHide(lesionCalculator);

          // üü° IMPORTANTE:
          // Si venimos de criterios familiares (fpg_50 o >=2fpg),
          // entonces ocultamos el recuadro de Riesgo Elevado.
          const checked = Array.from(form.querySelectorAll('input[name="factor"]:checked')).map(i => i.value);
          if(checked.includes('fpg_50') || checked.includes('>=2fpg')){
            resultBox.classList.add('hidden'); // Oculta el mensaje de alto riesgo
          }

          safeShow(familySection);

          // Desplazar autom√°ticamente a la pregunta de parentesco
          familySection.scrollIntoView({ behavior:"smooth", block:"center" });
        }
      }catch(err){ console.error('colon change', err); }
    });
  });


  // --- NUEVA L√ìGICA DE EVALUACI√ìN DE FAMILIARES ---
const famPrimer = document.getElementById("fam-primer");
const famSegundo = document.getElementById("fam-segundo");
const famTercer  = document.getElementById("fam-tercer");
const evalFamiliaresBtn = document.getElementById("eval-familiares");

// Bot√≥n Evaluar familiares
evalFamiliaresBtn.addEventListener("click", function(){

  const n1 = parseInt(famPrimer.value || "0", 10);   // primer grado
  const n2 = parseInt(famSegundo.value || "0", 10);  // segundo grado
  const n3 = parseInt(famTercer.value  || "0", 10);  // tercer grado

  safeHide(preguntaEdadFPG);

  // ‚â•2 familiares de primer grado ‚Üí Riesgo elevado
  if (n1 >= 2) {
    abrirModal("alto");
    return;
  }

  // 1 familiar de primer grado ‚Üí preguntar edad
  if (n1 === 1) {
    safeShow(preguntaEdadFPG);
    autoScroll(preguntaEdadFPG);
    return;
  }

  // Si n1 = 0 ‚Üí riesgo normal autom√°ticamente
  if (n1 === 0) {
    abrirModal("normal");
    return;
  }
});

// Cuando responde edad del √∫nico familiar de primer grado
document.querySelectorAll('input[name="edad-fpg"]').forEach(r => {
  r.addEventListener("change", function(e){
    if (e.target.value === "le50") abrirModal("alto");
    else abrirModal("normal");
  });
});


  // edad-fpg radios
  Array.from(document.getElementsByName('edad-fpg')||[]).forEach(r=> r.addEventListener('change', function(e){
    try{ if(e.target.value==='le50') abrirModal('alto'); else abrirModal('normal'); }catch(err){ console.error('edad-fpg change', err); }
  }));

  // reset
  resetBtn?.addEventListener('click', resetAll);

  // modal controls
  cerrarModalBtn?.addEventListener('click', function(){ cerrarModal(); });
  modal?.addEventListener('click', function(e){ if(e.target===modal) cerrarModal(); });

  // init state
  safeHide(resultBox, noAnte, lesionCalculator, familySection, preguntaNumFPG, preguntaEdadFPG, modal);

});

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/ColonCalcApp/www/sw.js')
        .then(reg => console.log('SW activo para este m√≥dulo'))
        .catch(err => console.error('Error al verificar SW', err));
    });
  }
  // Bloqueo espec√≠fico para Android/Chrome PWA
  document.addEventListener('touchstart', function (event) {
    if (event.touches.length > 1) {
      event.preventDefault(); // Bloquea el gesto de pinza
    }
  }, { passive: false });
</script>

</body>
</html>
